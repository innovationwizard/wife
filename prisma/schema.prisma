generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(cuid())
  name          String         @unique
  password      String
  role          Role           @default(CREATOR)
  items         Item[]         @relation("CreatedBy")
  capturedItems Item[]         @relation("CapturedBy")
  statusChanges StatusChange[] @relation("ChangedBy")
  createdAt     DateTime       @default(now())
}

model Item {
  id              String         @id @default(cuid())
  humanId         String         @unique @default(cuid())
  title           String
  rawInstructions String         @db.Text
  notes           String?        @db.Text              // Optional notes field
  type            ItemType       @default(TASK)
  status          ItemStatus     @default(INBOX)
  priority        Priority       @default(MEDIUM)
  swimlane        Swimlane       @default(PROJECT)
  labels          String[]
  
  // Relations
  createdByUserId String
  createdBy       User           @relation("CreatedBy", fields: [createdByUserId], references: [id])
  capturedByUserId String?
  capturedBy       User?          @relation("CapturedBy", fields: [capturedByUserId], references: [id])
  statusHistory   StatusChange[]
  routingNotes    String?        @db.Text
  
  // Freshness tracking
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  statusChangedAt DateTime       @default(now())  // When status last changed
  lastProgressAt  DateTime?                       // Last meaningful progress
  startedAt       DateTime?                       // When first moved to DOING
  completedAt     DateTime?                       // When moved to DONE
  blockedAt       DateTime?                       // When moved to BLOCKED
  
  // Metrics
  totalTimeInCreate Int?         @default(0)      // Total minutes in DOING status
  cycleCount        Int          @default(0)      // Times returned to TODO from DOING
  
  // Manual ordering within status/swimlane
  order             Int?                           // Manual ordering position (lower = first)
  
  @@index([status, statusChangedAt])              // For freshness queries
  @@index([createdByUserId, createdAt])           // For user's items
  @@index([swimlane, priority])                   // For kanban queries
  @@index([capturedByUserId, createdAt])
  @@index([status, swimlane, order])              // For manual ordering within columns
}

model StatusChange {
  id            String      @id @default(cuid())
  itemId        String
  item          Item        @relation(fields: [itemId], references: [id], onDelete: Cascade)
  fromStatus    ItemStatus?                          // null for initial creation
  toStatus      ItemStatus
  changedAt     DateTime    @default(now())
  changedById   String?
  changedBy     User?       @relation("ChangedBy", fields: [changedById], references: [id])
  reason        String?                             // Optional: why status changed
  duration      Int?                                // Minutes in previous status
  
  @@index([itemId, changedAt])                    // For history queries
}


model Rule {
  id          String   @id @default(cuid())
  ruleKey     String   @unique                     // e.g., "WIP_LIMIT"
  ruleValue   String                               // e.g., "1"
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
}

model SystemMessage {
  id        String   @id @default(cuid())
  ruleKey   String                                 // Links to Rule.ruleKey
  message   String
  severity  Severity @default(INFO)
  createdAt DateTime @default(now())
}


// Enums
enum Role {
  CREATOR
  STAKEHOLDER
}

enum ItemType {
  TASK
  INFO
}


enum ItemStatus {
  INBOX
  BACKLOG
  TODO
  DOING
  IN_REVIEW
  BLOCKED
  DONE
  ARCHIVE
}

enum Priority {
  HIGH
  MEDIUM
  LOW
}

enum Swimlane {
  EXPEDITE
  PROJECT
  HABIT
  HOME
}

enum Severity {
  ERROR
  WARNING
  INFO
  SUCCESS
}